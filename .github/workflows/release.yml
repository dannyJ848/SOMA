name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  NODE_VERSION: '20'
  RUST_VERSION: '1.77.2'

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create-release.outputs.id }}
      release_upload_url: ${{ steps.create-release.outputs.upload_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate changelog
        id: changelog
        run: |
          # Get version from tag
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Generate changelog for this release
          npm run changelog || true

      - name: Create Release
        id: create-release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Biological Self ${{ steps.changelog.outputs.version }}
          body: |
            ## Biological Self ${{ steps.changelog.outputs.version }}

            ### Downloads

            | Platform | Download |
            |----------|----------|
            | macOS (Apple Silicon) | [Biological Self-${{ steps.changelog.outputs.version }}-aarch64.dmg](https://github.com/${{ github.repository }}/releases/download/v${{ steps.changelog.outputs.version }}/Biological Self-${{ steps.changelog.outputs.version }}-aarch64.dmg) |
            | macOS (Intel) | [Biological Self-${{ steps.changelog.outputs.version }}-x64.dmg](https://github.com/${{ github.repository }}/releases/download/v${{ steps.changelog.outputs.version }}/Biological Self-${{ steps.changelog.outputs.version }}-x64.dmg) |
            | Windows | [Biological Self-${{ steps.changelog.outputs.version }}-x64-setup.exe](https://github.com/${{ github.repository }}/releases/download/v${{ steps.changelog.outputs.version }}/Biological Self-${{ steps.changelog.outputs.version }}-x64-setup.exe) |
            | Linux (AppImage) | [Biological Self-${{ steps.changelog.outputs.version }}-x86_64.AppImage](https://github.com/${{ github.repository }}/releases/download/v${{ steps.changelog.outputs.version }}/Biological Self-${{ steps.changelog.outputs.version }}-x86_64.AppImage) |
            | Linux (deb) | [Biological Self-${{ steps.changelog.outputs.version }}-amd64.deb](https://github.com/${{ github.repository }}/releases/download/v${{ steps.changelog.outputs.version }}/Biological Self-${{ steps.changelog.outputs.version }}-amd64.deb) |

            ### What's Changed

            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for full details.

            ### Privacy First

            Biological Self processes all data locally on your device. Your health information never leaves your computer.
          draft: true
          prerelease: false

  build-release:
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: aarch64-apple-darwin
            name: macOS-arm64
            ext: dmg
          - platform: macos-latest
            target: x86_64-apple-darwin
            name: macOS-x64
            ext: dmg
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            name: Linux-x64
            ext: AppImage
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            name: Windows-x64
            ext: msi

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: ${{ matrix.target }}

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libgtk-3-dev \
            libayatana-appindicator3-dev

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build:prod

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # macOS code signing
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          # Windows code signing
          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: --target ${{ matrix.target }}

  publish-release:
    needs: [create-release, build-release]
    runs-on: ubuntu-latest
    steps:
      - name: Publish Release
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: ${{ needs.create-release.outputs.release_id }},
              draft: false
            })
