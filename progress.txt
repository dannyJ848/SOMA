# Biological Self - Progress & Learnings

## Completed Work

### Phase 0: Foundation (COMPLETE)
- [x] Encrypted SQLite data store with AES-256-GCM
- [x] Core health data types (conditions, meds, allergies, surgeries, family history, labs, vitals, imaging)
- [x] Lab results importer with LLM extraction
- [x] Pharmacogenomics data model (gene variants, phenotypes, drug guidance)
- [x] Neuropsychological evaluations with longitudinal tracking
- [x] Imaging reports importer (CT scans)
- [x] Whoop wearable integration (cycles + workouts)
- [x] Apple Health integration (daily summaries + workouts)

### Data Imported
- 75 lab results from Whoop Labs PDFs
- 24 pharmacogenomic genes + 30 drug guidance from Quest Diagnostics
- 3 neuropsych evaluations (2018, 2019, 2025) showing longitudinal cognitive changes
- 4 CT imaging reports (SBO history 2017-2021)
- 255 Whoop cycles + 247 Whoop workouts (Apr-Dec 2025)
- 891 Apple Health daily summaries + 647 workouts (2019-2026)

## Key Learnings

### 1. Date Handling Critical
Always deserialize dates from JSON. Forgetting this causes subtle bugs where date comparisons fail.

### 2. Duplicate Detection Pattern
Before importing, always check for existing records using a unique identifier (date + type, or specific ID).

### 3. Large File Streaming
For 100MB+ files (Apple Health XML), use streaming parsers not in-memory loading.

### 4. Store Pattern
After calling store.addX(), call store.get() again to refresh the self object.

### 5. Passphrase from Environment
Use BIOSELF_PASSPHRASE environment variable for non-interactive scripts.

## Codebase Patterns

- **IPC Bridge Pattern**: Tauri Rust commands call TypeScript via `npx tsx tauri-bridge.ts <command>` with env vars for passphrase and db path
- **React Frontend**: All UI in `src/` directory, Vite builds to `dist/`
- **Tauri Config**: Main config in `src-tauri/tauri.conf.json`, capabilities in `src-tauri/capabilities/`
- **Run Dev**: Use `npm run tauri:dev` to start both Vite and Tauri
- **TypeScript Check**: Run `npm run typecheck` before committing

---

## 2026-01-20 - US-009

### What was implemented
- Tauri 2.x desktop app shell with React frontend
- Vite build configuration for development and production
- IPC bridge script (`tauri-bridge.ts`) connecting Rust commands to TypeScript database layer
- React app with authentication flow and dashboard showing health data counts
- Dark theme UI with responsive design
- Window chrome configuration (1024x768, centered, resizable)

### Files changed
- **New**: `src-tauri/` - Rust backend with IPC commands
- **New**: `src/` - React frontend (App.tsx, main.tsx, styles.css)
- **New**: `tauri-bridge.ts` - TypeScript CLI for Tauri IPC
- **New**: `vite.config.ts` - Vite configuration
- **New**: `index.html` - Vite entry point
- **New**: `public/icon.svg` - App icon
- **Modified**: `package.json` - Added Tauri/Vite scripts and dependencies
- **Modified**: `tsconfig.json` - Updated for React/JSX support
- **Modified**: Various files to fix unused import/variable TypeScript errors

### Learnings for future iterations
- Tauri 2.x requires the shell plugin for running external commands
- First Rust build takes several minutes (compiling 400+ crates)
- The bridge pattern (Rust -> TypeScript via CLI) works well for keeping existing database code
- Capabilities must be configured in `src-tauri/capabilities/default.json` for shell access
- CSP must allow `style-src 'unsafe-inline'` for React inline styles

---

## 2026-01-20 - US-010

### What was implemented
- Enhanced first-run experience with comprehensive privacy explanation
- Passphrase creation with confirmation field for new databases
- Password strength indicator (Too short → Weak → Good → Strong)
- Three privacy feature cards explaining encryption, local-only storage, and user control
- Improved unlock flow for existing databases
- Error handling with clear messages and "Clear and try again" option
- Loading states during submit operations

### Files changed
- **Modified**: `src/App.tsx` - Complete auth flow overhaul
- **Modified**: `src/styles.css` - New styles for auth components

### Learnings for future iterations
- Keep auth flow separate from dashboard - makes state management cleaner
- Passphrase strength should guide users but not block (8 char minimum is enforced)
- Error messages should be actionable - include retry mechanism
- Privacy messaging is important for user trust in a health app

---

## 2026-01-20 - US-011

### What was implemented
- Extended tauri-bridge.ts with `get-dashboard` command returning full health data
- Added Rust structs for dashboard data types (ConditionSummary, MedicationSummary, LabWithTrend, VitalsSummary)
- Implemented session passphrase storage in Rust for subsequent IPC calls
- Created comprehensive dashboard with four main sections:
  - Vitals Summary: resting HR, HRV, recovery score, sleep hours, steps
  - Active Conditions: list with status badges (active/chronic)
  - Current Medications: list with dosage and frequency
  - Recent Labs: grid with values, units, and trend indicators
- Lab trend calculation uses 5% threshold to determine up/down/stable
- Empty states with contextual icons for all sections
- Data summary footer with total counts

### Files changed
- **Modified**: `tauri-bridge.ts` - Added get-dashboard command with trend calculation
- **Modified**: `src-tauri/src/lib.rs` - Added DashboardData structs and get_dashboard command
- **Modified**: `src/App.tsx` - Full dashboard implementation with cards
- **Modified**: `src/styles.css` - Dashboard styles (grids, cards, badges, trends)

### Learnings for future iterations
- Store passphrase in Rust static for session persistence (avoids re-auth on each call)
- Trend calculation needs threshold to avoid noise (5% works well)
- serde_json::Value useful for polymorphic fields (lab values can be number or string)
- Grid layouts with auto-fit work well for responsive card layouts

---

## 2026-01-20 - US-012

### What was implemented
- Timeline data aggregation in tauri-bridge.ts collecting events from labs, imaging, conditions, medications, surgeries
- New `get-timeline` Rust command with optional filter parameters (types, startDate, endDate)
- Timeline React component with vertical layout and color-coded event markers
- Six event type colors: lab=blue, imaging=purple, condition=amber, medication=emerald, surgery=red, symptom=orange
- Filter toggles allowing users to show/hide event types
- Date range selector with clear button
- Click-to-detail modal showing full event information
- Navigation between dashboard and timeline views

### Files changed
- **Modified**: `tauri-bridge.ts` - Added TimelineEvent/TimelineData interfaces, getTimelineEvents, getTimelineData functions, and get-timeline command
- **Modified**: `src-tauri/src/lib.rs` - Added TimelineEvent, TimelineFilters, TimelineData structs and get_timeline command
- **Modified**: `src/App.tsx` - Added Timeline view, filters, date range selector, event detail modal, navigation
- **Modified**: `src/styles.css` - Added timeline styles (controls, items, markers, modal)

### Learnings for future iterations
- Rust command parameters should be Optional types for clean API design
- CSS timeline with ::before pseudo-element for the vertical line works well
- Modal pattern: overlay onClick closes, content stopPropagation prevents close
- Event color mapping with Record<Type, string> provides type safety
- useEffect dependencies should include filter state for auto-reload on filter change

---

## 2026-01-20 - US-013

### What was implemented
- Symptom interface with comprehensive fields: description, severity (1-10 literal type), bodyLocation (hierarchical string), onsetDate, duration, resolvedDate, status, associatedFactors, quality, frequency, timeOfDay, notes
- SymptomDuration interface for tracking duration with value and unit (minutes/hours/days/weeks/months/ongoing)
- AssociatedFactor type with 14 predefined values (after-eating, with-exertion, at-rest, etc.)
- SymptomQuality type with 15 predefined descriptors (sharp, dull, aching, burning, etc.)
- Store CRUD methods: addSymptom, updateSymptom, removeSymptom, resolveSymptom
- Store query methods: getActiveSymptoms, getSymptomsByLocation (with prefix matching), getSymptomsByDateRange
- Deserialize handles symptom dates (onsetDate, resolvedDate, createdAt, updatedAt)
- Search method includes symptoms (searches description, bodyLocation, notes)

### Files changed
- **Modified**: `core/biological-self/types.ts` - Added Symptom, SymptomDuration, AssociatedFactor, SymptomQuality types; added symptoms[] to BiologicalSelf
- **Modified**: `core/biological-self/store.ts` - Added Symptom import, symptoms array init, CRUD methods, query methods, deserialize, search

### Learnings for future iterations
- Use literal union types (1 | 2 | ... | 10) for bounded numeric values
- Prefix matching on hierarchical location codes enables flexible queries (e.g., "body.torso" matches all torso symptoms)
- Type aliases (AssociatedFactor, SymptomQuality) document valid values while being lightweight
- Include || [] fallback in deserialize for backwards compatibility with existing data

---

## 2026-01-20 - US-014

### What was implemented
- BodyDiagram.tsx component with SVG-based body outline
- Anterior (front) view with 26 body regions (head, neck, torso, arms, legs)
- Posterior (back) view with 24 body regions
- Toggle buttons to switch between anterior/posterior views
- Hover effect highlights region with tooltip showing region name
- Click-to-select functionality with visual selection state
- Symptom markers displayed on regions with existing symptoms
- Body Map view integrated into main app navigation
- Selected region ID available for passing to symptom entry form (US-015)
- Hierarchical body location codes (e.g., body.torso.abdomen.right-lower-quadrant)
- Helper functions: getRegionName(), getAllRegions()

### Files changed
- **New**: `src/BodyDiagram.tsx` - SVG body diagram component with regions and interaction
- **Modified**: `src/App.tsx` - Added body view, body diagram state, navigation
- **Modified**: `src/styles.css` - Added body diagram styles (regions, tooltips, markers, controls)

### Learnings for future iterations
- SVG paths for body regions can be simplified polygons, doesn't need perfect anatomy
- Tooltip positioning needs transform: translateX(-50%) for centering
- Use data-location attribute pattern for associating regions with hierarchical codes
- Symptom markers use prefix matching to find parent regions
- Keep anterior/posterior regions in separate arrays for clean view switching

---

## 2026-01-20 - US-015

### What was implemented
- Add-symptom command in tauri-bridge.ts receiving JSON data as argument
- Rust add_symptom command with SymptomInput struct for type-safe deserialization
- SymptomEntryForm React component with comprehensive form fields:
  - Body location dropdown (pre-selected from diagram via getAllRegions helper)
  - Symptom description textarea
  - Severity slider (1-10) with descriptive labels (Minimal→Worst possible)
  - Date/time picker for onset using datetime-local input
  - Duration toggle (ongoing vs specific with value + unit)
  - Associated factors checkboxes (13 predefined values from types.ts)
  - Additional notes textarea
- Integration into Body Map view with form state management
- Dashboard recentSymptoms now populated from actual symptom data
- Timeline view includes symptoms as orange event markers
- Form validation (description and body location required)
- Save/cancel flow with dashboard refresh on successful save

### Files changed
- **Modified**: `tauri-bridge.ts` - Added add-symptom case, getRecentSymptoms function, symptoms in timeline events
- **Modified**: `src-tauri/src/lib.rs` - Added SymptomInput, SymptomDuration, AddSymptomResult structs and add_symptom command
- **New**: `src/SymptomEntryForm.tsx` - Complete symptom entry form component
- **Modified**: `src/App.tsx` - Added showSymptomForm state, integrated SymptomEntryForm in body view
- **Modified**: `src/styles.css` - Added 288 lines of form styles (slider, checkboxes, duration controls)

### Learnings for future iterations
- Pass complex data to tauri-bridge via JSON string argument (process.argv[3])
- Use serde rename attributes for camelCase→snake_case field mapping in Rust
- getAllRegions() helper from BodyDiagram.tsx provides sorted, deduplicated list
- Symptom severity as literal type (1|2|...|10) requires casting when passing to invoke
- Duration "ongoing" is stored as {value: 0, unit: "ongoing"} rather than undefined
- Form components should call parent callbacks (onSave/onCancel) rather than managing navigation

---

---

## 2026-01-20 - US-016

### What was implemented
- Ollama service module (core/ai/ollama.ts) with comprehensive TypeScript interface
- Functions: checkOllamaHealth, isOllamaAvailable, listModels, hasModel, getDefaultModel
- Chat completion: chat (non-streaming), streamChat (callback-based), streamChatGenerator (async iterator)
- JSON mode: chatJSON<T> for structured output parsing
- AI bridge CLI (ai-bridge.ts) for Tauri IPC commands: health, models, chat, chat-json, stream
- Rust Tauri commands: ai_health, ai_models, ai_chat, ai_chat_json
- Type definitions: OllamaModel, ChatMessage, ChatRequest, ChatResponse, StreamChunk, OllamaStatus

### Files changed
- **New**: `core/ai/ollama.ts` - Full Ollama service implementation (437 lines)
- **New**: `ai-bridge.ts` - CLI for Tauri AI IPC (181 lines)
- **Modified**: `src-tauri/src/lib.rs` - Added AI types and commands
- **Modified**: `prd.json` - US-016 passes: true

### Learnings for future iterations
- **AI Bridge Pattern**: Same pattern as tauri-bridge.ts but for AI operations via ai-bridge.ts
- Default model is deepseek-r1:14b (configurable via DEFAULT_MODEL constant)
- Ollama REST API at http://localhost:11434 - use /api/version for health, /api/tags for models, /api/chat for completion
- Streaming responses are NDJSON format, process line-by-line
- AbortSignal.timeout() provides clean timeout handling for fetch requests
- For JSON mode, pass format: 'json' in request body

---

## 2026-01-20 - US-017

### What was implemented
- ChatView React component with full conversational interface
- Health context builder (buildHealthContext) extracts relevant health data for AI prompts
- System prompt template with educational guidelines and medical disclaimer
- Ollama health check on component mount with retry capability
- Suggested questions for empty chat state
- User/assistant message styling with avatars
- Typing indicator during AI response
- Chat navigation button in dashboard header

### Files changed
- **New**: `src/ChatView.tsx` - Complete chat interface component (280 lines)
- **Modified**: `src/App.tsx` - Added chat view rendering and navigation
- **Modified**: `src/styles.css` - Added 330 lines of chat-specific styles
- **Modified**: `prd.json` - US-017 passes: true

### Learnings for future iterations
- Health context should be concise - only include active conditions, current meds, recent symptoms, abnormal labs
- System prompt template with placeholder (`{HEALTH_CONTEXT}`) allows dynamic context injection
- AI status check on mount catches Ollama not running before user tries to chat
- Suggested questions help users understand what they can ask
- Use `white-space: pre-wrap` on message content to preserve AI formatting

---

## 2026-01-20 - US-018

### What was implemented
- Two-mode SymptomEntryForm: NL input mode and manual form mode
- NL input mode with textarea for natural language description
- AI parsing using JSON mode with structured output prompt
- Body location mapping (BODY_LOCATION_MAP) from common terms to hierarchical codes
- Form pre-fill with parsed data (description, severity, location, duration, factors)
- "Parse with AI" button with loading spinner
- "Fill form manually instead" fallback option
- "Describe naturally" button in manual mode header to switch back
- AI availability check on mount with warning message

### Files changed
- **Modified**: `src/SymptomEntryForm.tsx` - Added NL mode, parsing function, body location mapping (200+ lines)
- **Modified**: `src/styles.css` - Added NL input styles (150+ lines)
- **Modified**: `prd.json` - US-018 passes: true

### Learnings for future iterations
- Body location mapping handles common synonyms (stomach→abdomen, belly→abdomen)
- Use low temperature (0.3) for structured data extraction to reduce hallucination
- Fallback to manual mode when AI unavailable - don't block the user
- Preselected region from body diagram should skip NL mode (already have location)
- JSON mode response comes as `{ result: T, success: boolean }`

---

## 2026-01-20 - US-019

### What was implemented
- InsightsPanel component with AI-powered health data analysis
- buildDataSummary function extracts relevant health data for AI prompts
- System prompt instructs AI to generate 2-4 objective insights as JSON array
- Skeleton loading animation while generating insights
- Refresh button to regenerate insights on demand
- dataVersion prop triggers insights refresh when dashboard data changes
- Educational disclaimer in panel header
- Panel hides itself when AI is unavailable

### Files changed
- **New**: `src/InsightsPanel.tsx` - Complete insights panel component (200 lines)
- **Modified**: `src/App.tsx` - Added InsightsPanel import and dataVersion state
- **Modified**: `src/styles.css` - Added 150+ lines of insights panel styles
- **Modified**: `prd.json` - US-019 passes: true

### Learnings for future iterations
- Use JSON array output for structured insights (easier to parse and display)
- dataVersion pattern allows parent to signal data changes to children
- Skeleton loading animation (shimmer effect) provides good UX during AI generation
- Hide components gracefully when dependencies unavailable rather than showing errors
- Focus AI prompts on patterns and correlations, not diagnoses

---

## Phase 2 Complete

All AI layer user stories implemented:
- US-016: Local LLM integration with Ollama
- US-017: AI chat interface
- US-018: Natural language symptom entry
- US-019: Health insights panel

---

## 2026-01-20 - Phase 3 PRD Created

### What was implemented
- Comprehensive Phase 3 PRD with 53 user stories (US-020 to US-072)
- phase3-draft.md planning document with technical architecture

### Phase 3 Structure (7 sub-phases)
- **3A: 3D Foundation** (US-020–027): Three.js, camera, Z-Anatomy, VHP cadaver, layers, selection, clipping
- **3B: Content System** (US-028–029): 5-tier complexity levels, multi-level data model
- **3C: Knowledge Infrastructure** (US-030–041): ChromaDB, embeddings, OpenStax, StatPearls, histology, FMA/HPO, RAG
- **3D: Anatomical Systems** (US-042–053): All 11 body systems with 5-level educational content
- **3E: Biomarker Integration** (US-054–059): Lab-to-organ mapping, pathway visualization
- **3F: Symptom Integration** (US-060–065): Symptom-to-anatomy, differentials, referral patterns
- **3G: Personalized Learning** (US-066–072): Progress tracking, quizzes, AI cueing

### Key Decisions Made
1. Full detail from start - no progressive loading (~10-18GB storage)
2. Include VHP cadaver cross-sections
3. Include complete histology database
4. 5 complexity levels: 8th grade → high school → college → graduate → MD
5. Extensive symptom ↔ biomarker ↔ anatomy linking
6. Precise AI cueing for proactive education

### Files changed
- **Modified**: `prd.json` - Added 53 Phase 3 user stories
- **New**: `phase3-draft.md` - Comprehensive planning document (870 lines)

### Learnings for future iterations
- Z-Anatomy (CC-BY-SA) provides complete 3D anatomy models
- Visible Human Project is public domain (NIH)
- OpenStax A&P and StatPearls are CC-BY - perfect for RAG
- FMA ontology (~80k terms) critical for structure linking
- HPO ontology links symptoms to anatomical locations
- @xenova/transformers enables browser-compatible local embeddings
- OpenSeadragon handles deep zoom for histology images

---

## 2026-01-20 - US-020

### What was implemented
- AnatomyViewer React component using @react-three/fiber
- WebGL2 renderer with antialiasing and dpr scaling [1, 2]
- Three-point lighting system (ambient + 2 directional lights)
- Perspective camera at 45° FOV
- OrbitControls with damping for smooth interaction
- Preset anatomical views with smooth animated transitions
- Stats component for FPS monitoring in dev mode
- Placeholder capsule/sphere model as body stand-in

### Files changed
- **New**: `src/AnatomyViewer.tsx` - Complete 3D viewer component (250 lines)
- **Modified**: `src/App.tsx` - Added anatomy view and navigation
- **Modified**: `src/styles.css` - Added anatomy viewer styles (160 lines)
- **Modified**: `prd.json` - US-020 passes: true
- **Modified**: `package.json` - Added three, @react-three/fiber, @react-three/drei

### Learnings for future iterations
- **React Three Fiber pattern**: Use `<Canvas>` wrapper with inner components for Three.js objects
- **Camera animation**: Use requestAnimationFrame with lerp for smooth transitions
- **OrbitControls ref**: Access via ref to programmatically control camera position
- **Dev mode detection**: Use `window.location.hostname === 'localhost'` instead of `import.meta.env.DEV` to avoid Vite type issues
- **dpr setting**: Use `dpr={[1, 2]}` for retina display support while limiting max pixel ratio
- **Stats component**: From @react-three/drei, shows FPS/memory in dev mode

---

## 2026-01-20 - US-024

### What was implemented
- ModelLoader.tsx with comprehensive GLTF loading infrastructure
- useModelLoader hook: loadModel, cancelLoad, retryLoad, clearCache, getLoadState, isCached
- GLTFLoader configured with DRACOLoader for compressed models
- Loading progress tracking (0-100%) with abort controller support
- In-memory model cache (Map) to avoid reloading
- LoadingProgress component with progress bars, cancel/retry buttons
- Model component for easy rendering with position/rotation/scale
- useSystemLoader hook for lazy loading anatomical systems
- AnatomicalSystem type with 11 body systems defined

### Files changed
- **New**: `src/ModelLoader.tsx` - Complete model loading system (350 lines)
- **Modified**: `src/styles.css` - Loading progress overlay styles (120 lines)
- **Modified**: `prd.json` - US-024 passes: true

### Learnings for future iterations
- **DRACO decoder**: Use CDN path for decoder (gstatic.com/draco) or bundle locally
- **AbortController pattern**: Store in ref Map to cancel specific loads
- **Model cache**: Use Map<string, THREE.Group> at module level for persistence
- **Clone models**: Always clone from cache to allow multiple instances
- **Progress events**: GLTFLoader provides loaded/total bytes for progress calculation

---

## 2026-01-20 - US-025

### What was implemented
- LayerPanel.tsx component with full layer management UI
- 7 primary anatomical layers with sublayers (21 total)
- useLayerState hook for state management
- Visibility toggles, opacity sliders, solo mode
- 6 preset configurations (All Systems, Musculoskeletal, etc.)
- Expandable sublayer accordions
- localStorage persistence of layer state
- Integrated into AnatomyViewer with toggle button

### Files changed
- **New**: `src/LayerPanel.tsx` - Complete layer management (430 lines)
- **Modified**: `src/AnatomyViewer.tsx` - Integrated LayerPanel
- **Modified**: `src/styles.css` - Layer panel styles (250 lines)
- **Modified**: `prd.json` - US-025 passes: true

### Learnings for future iterations
- **Layer hierarchy**: Use dot notation (e.g., `cardiovascular.arteries`) for sublayer IDs
- **Solo mode pattern**: Store solo layer ID separately, apply in isVisible()
- **localStorage persistence**: Serialize Map to object for JSON.stringify
- **Preset system**: Define activeLayers array and filter visibility accordingly
- **Opacity inheritance**: Sublayer opacity should multiply with parent opacity

---

## 2026-01-20 - US-026

### What was implemented
- SelectionManager.tsx with comprehensive selection infrastructure
- useSelectionManager hook: select, addToSelection, toggleSelection, clearSelection
- RaycasterManager component for mouse picking using THREE.Raycaster
- OutlineEffect component for visual selection feedback
- SelectionInfo panel showing structure details
- Multi-select with Shift+click
- HIGHLIGHT_COLORS for hover/selected states
- useHighlightMaterials hook for material management
- StructureMetadata interface for FMA integration

### Files changed
- **New**: `src/SelectionManager.tsx` - Complete selection system (320 lines)
- **Modified**: `src/styles.css` - Selection info panel styles (130 lines)
- **Modified**: `prd.json` - US-026 passes: true

### Learnings for future iterations
- **Raycaster pattern**: Use useFrame to check hover state, event listener for clicks
- **Material swapping**: Store original materials in Map keyed by mesh.uuid
- **Multi-select**: Use Shift key event.shiftKey to toggle selection mode
- **Mesh registry**: Store Map<id, {mesh, metadata}> for structure lookup
- **Outline geometry**: Use THREE.EdgesGeometry(geometry, threshold) for edge detection

---

## 2026-01-20 - US-027

### What was implemented
- ClippingPlanes.tsx with anatomical cross-section system
- Three orthogonal planes: sagittal (L-R), coronal (F-B), axial (T-B)
- useClippingPlanes hook for state management with animation
- ClippingPlanesManager applies THREE.Plane to renderer
- PlaneIndicator shows visual plane position in scene
- ClippingControlPanel with full UI controls
- 5 presets: None, Midsagittal, Frontal, Transverse, Quarter View
- Position sliders with percentage display
- Invert button to flip clipping direction

### Files changed
- **New**: `src/ClippingPlanes.tsx` - Complete clipping system (420 lines)
- **Modified**: `src/styles.css` - Clipping panel styles (190 lines)
- **Modified**: `prd.json` - US-027 passes: true

### Learnings for future iterations
- **THREE.Plane**: Use (normal, constant) where constant is distance from origin
- **Global clipping**: Set gl.localClippingEnabled and gl.clippingPlanes
- **Plane position**: Map -1..1 to model bounds min..max for intuitive control
- **Inversion**: Negate normal vector to flip which side is clipped
- **Animation pattern**: Use setInterval with eased interpolation for smooth transitions

---

## 2026-01-20 - US-028

### What was implemented
- ComplexityLevel.tsx with 5-tier content complexity system
- Level definitions with names, descriptions, audiences, characteristics
- ComplexityProvider React context for global state management
- useComplexityLevel hook for accessing/setting current level
- ComplexitySelector component (full slider and compact button variants)
- ComplexityContent wrapper for level-gated rendering
- MultiLevelContent for displaying best-match level content
- useMultiLevelContent hook for programmatic content access
- localStorage persistence of user preference

### Files changed
- **New**: `src/ComplexityLevel.tsx` - Complete complexity system (310 lines)
- **Modified**: `src/styles.css` - Complexity selector styles (190 lines)
- **Modified**: `prd.json` - US-028 passes: true

### Learnings for future iterations
- **Context pattern**: Use React context with provider for app-wide settings
- **Fallback content**: When exact level not available, find closest lower level first
- **CSS custom properties**: Use `--level-color` for dynamic styling via style prop
- **Gradient slider**: CSS linear-gradient on range input track for visual levels
- **Type safety**: Use literal union types (1|2|3|4|5) for constrained values

---

## Phase 3 Progress Summary

### Completed Stories (7 total)
- **US-020**: Three.js scene and renderer setup
- **US-021**: Camera orbit controls
- **US-024**: GLTF model loader with progress
- **US-025**: Anatomical layer system
- **US-026**: Structure selection and highlighting
- **US-027**: Cross-section clipping planes
- **US-028**: Complexity level system

### Skipped Stories (require manual download)
- **US-022**: Z-Anatomy model acquisition
- **US-023**: Visible Human Project cadaver cross-sections

### New Components Created
- AnatomyViewer.tsx - Main 3D viewer with Three.js
- ModelLoader.tsx - GLTF loading with progress
- LayerPanel.tsx - Anatomical layer management
- SelectionManager.tsx - Structure selection/highlighting
- ClippingPlanes.tsx - Cross-section visualization
- ComplexityLevel.tsx - 5-tier content system

### Total Lines Added
- ~3,800 lines of TypeScript/React
- ~1,200 lines of CSS

---

## Notes for Future Iterations

- The user is a medical student, so clinical accuracy matters
- Vision includes Complete Anatomy-level 3D interface
- All data must stay local - this is the core differentiator
- Educational only, never diagnostic
- Phase 3 is the largest phase - estimated 10-18GB of assets
- US-022 and US-023 require manual download of model/image datasets
- Branch: ralph/phase-3-physiology-learning


## 2026-01-21 - US-032 through US-039

### What was implemented (8 stories)

**US-032: OpenStax A&P Ingestion Pipeline**
- Created core/ingest/openstax.ts with chapter definitions for 28 chapters
- HTML parsing with section extraction
- Text chunking with configurable overlap (500 tokens, 50 overlap)
- Embedding generation via @xenova/transformers
- Sample content for cardiovascular system (heart chapters)

**US-033: StatPearls Medical Articles Ingestion**
- Created core/ingest/statpearls.ts for NCBI/PMC integration
- Article structure parsing (abstract, sections, key points)
- MeSH term classification for body systems
- Sample content for heart, liver, brain, pulmonary, renal topics

**US-034: Histology Image Database**
- Created core/histology/types.ts with comprehensive type definitions
- TissueCategory, StainType, Magnification types
- AnnotationPoint and AnnotationRegion interfaces
- HistologyImage metadata schema with anatomy linking
- Created core/histology/store.ts for image management
- Sample tissue type descriptions with 5-level characteristics
- Sample histology images with annotations

**US-035: Histology Viewer Component**
- Created src/HistologyViewer.tsx with pan/zoom functionality
- Mouse and touch support for navigation
- Annotation point and region overlays with click interaction
- Side-by-side image comparison mode
- Info panel with complexity-appropriate content
- Magnification indicator with zoom controls
- Source attribution and license display

**US-036: FMA Ontology Integration**
- Created core/ontology/fma.ts for Foundational Model of Anatomy
- FMAEntity interface with hierarchical relationships (is-a, part-of, has-part)
- Query methods: getParents, getChildren, getParts, getAncestors, getDescendants
- Name and synonym search with indexing
- 3D mesh mapping for structure identification
- Sample data for major organ systems

**US-037: HPO Integration**
- Created core/ontology/hpo.ts for Human Phenotype Ontology
- HPOTerm interface with anatomical location mapping
- Symptom-to-structure and structure-to-symptom queries
- Body region indexing for navigation
- Cross-reference support (MeSH, UMLS, SNOMED)
- Sample phenotype terms covering major symptom categories

**US-038: RAG Retrieval Pipeline**
- Created core/rag/retrieval.ts for semantic search
- Multi-collection search with result merging
- Re-ranking by relevance score
- Complexity-level filtering
- Token limit management for context windows
- Source deduplication
- Specialized retrieval for structures, symptoms, lab results

**US-039: AI Response with Citations**
- Created core/rag/cited-response.ts for grounded AI responses
- Citation parsing from AI output [1], [2] format
- System prompt template with citation instructions
- Streaming response support with progressive citation extraction
- Academic citation formatting utilities

### Files changed
- **New**: core/ingest/openstax.ts (388 lines)
- **New**: core/ingest/statpearls.ts (600 lines)
- **New**: core/histology/types.ts (165 lines)
- **New**: core/histology/store.ts (425 lines)
- **New**: src/HistologyViewer.tsx (520 lines)
- **New**: core/ontology/fma.ts (490 lines)
- **New**: core/ontology/hpo.ts (430 lines)
- **New**: core/rag/retrieval.ts (320 lines)
- **New**: core/rag/cited-response.ts (265 lines)
- **Modified**: prd.json - 8 stories marked passes: true

### Learnings for future iterations
- **LanceDB over ChromaDB**: Embedded/serverless operation without separate process
- **@xenova/transformers**: Works well for local embeddings, ~23MB for all-MiniLM-L6-v2
- **Ontology indexing**: Use multiple indexes (name, synonym, category) for fast lookup
- **Hierarchical queries**: Recursive traversal with depth limits prevents infinite loops
- **RAG token management**: Always estimate and cap context to fit model window
- **Citation parsing**: Regex for [N] pattern, match to retrieved chunk indices
- **Streaming with citations**: Citations extracted after full response received

---

## 2026-01-21 - US-040 and US-041

### What was implemented (2 stories)

**US-040: Content Viewer Panel**
- Created src/ContentViewer.tsx for full-text source viewing
- Markdown-like content rendering (headers, lists, bold, italic)
- Citation highlighting with scroll-to-passage
- Document outline sidebar with heading navigation
- Font size controls (A-, A+)
- Bookmarking functionality
- Related documents linking
- Source attribution and license display

**US-041: Structure Info Panel with Multi-Level Content**
- Created src/StructureInfoPanel.tsx for selected structure details
- Panel shows: name, Latin name, system, location
- 5-level explanation display with fallback to lower levels
- Collapsible sections (Key Facts, Related Structures, Clinical)
- Related structures with navigation links (partOf, hasParts, relatedTo)
- Clinical correlations (shown only at level 4-5)
- Related lab tests display
- Quick action buttons (View in Isolation, View Histology)
- Ask AI suggestions for structure-specific questions
- Loading skeleton and error states
- Sample data generation for testing (heart example)

### Files changed
- **New**: src/ContentViewer.tsx (552 lines)
- **New**: src/StructureInfoPanel.tsx (708 lines)
- **Modified**: prd.json - US-040 and US-041 passes: true

### Learnings for future iterations
- **Variable naming**: Avoid `document` as prop name (conflicts with global)
- **Level fallback**: When content not available at user's level, try lower levels first
- **Collapsible sections**: Use Set<string> for tracking expanded section IDs
- **Sample data**: Create realistic examples for each major organ during dev
- **Panel patterns**: Loading skeleton, error with retry, and loaded states

---

## 2026-01-21 - US-042 through US-045

### What was implemented (4 body system modules)

**US-042: Skeletal System Module**
- Created core/anatomy/skeletal/ with types.ts, store.ts, index.ts
- Complete bone data model with BoneType, SkeletalDivision, SkeletalRegion
- All 206 bones with detailed info for cranial bones, basic templates for others
- Bone landmarks, muscle attachments, blood supply, innervation
- Joint references and articulations
- Common fractures and pathologies
- 5-level educational content for each bone
- API functions: getBone, getAllBones, getBonesByRegion, searchBones, getBoneStatistics

**US-043: Muscular System Module**
- Created core/anatomy/muscular/ with types.ts, store.ts, index.ts
- Complete muscle data model with MuscleShape, MuscularRegion, MuscleGroup
- Major muscles with detailed info (deltoid, biceps, triceps as examples)
- Origins, insertions, actions, innervation, blood supply
- Fiber composition (Type I, IIa, IIb percentages)
- Agonist/antagonist/synergist relationships
- Common injuries and pathologies
- Exercise correlations
- 5-level educational content
- API functions: getMuscle, getMusclesByRegion, getMusclesByGroup, getAntagonists, getSynergists

**US-044: Cardiovascular System Module**
- Created core/anatomy/cardiovascular/ with types.ts, store.ts, index.ts
- Heart chambers (4) with pressure values, wall thickness
- Cardiac valves (4) with pathologies (stenosis, regurgitation, prolapse)
- Conduction system (SA node, AV node, Bundle of His)
- Major blood vessels (arteries, veins, coronary circulation)
- Cardiac cycle phases (7 phases with valve states, pressure changes)
- Coronary territories with ECG lead correlations
- ECG wave correlations
- 5-level educational content
- API functions: getChamber, getValve, getConductionNode, getVessel, getVesselsByRegion

**US-045: Respiratory System Module**
- Created core/anatomy/respiratory/ with types.ts, store.ts, index.ts
- Upper respiratory tract (nasal cavity, pharynx, larynx)
- Lower respiratory tract (trachea, bronchi)
- Lungs with lobes and bronchopulmonary segments
- Respiratory muscles (diaphragm, intercostals)
- Ventilation parameters (TV, RR, VC, FEV1, TLC, RV, FRC)
- Gas exchange concepts (diffusion, V/Q matching)
- 5-level educational content
- API functions: getStructure, getLung, getMuscle, getStatistics

### Files changed
- **New**: core/anatomy/skeletal/types.ts (180 lines)
- **New**: core/anatomy/skeletal/store.ts (700 lines)
- **New**: core/anatomy/skeletal/index.ts
- **New**: core/anatomy/muscular/types.ts (220 lines)
- **New**: core/anatomy/muscular/store.ts (650 lines)
- **New**: core/anatomy/muscular/index.ts
- **New**: core/anatomy/cardiovascular/types.ts (210 lines)
- **New**: core/anatomy/cardiovascular/store.ts (850 lines)
- **New**: core/anatomy/cardiovascular/index.ts
- **New**: core/anatomy/respiratory/types.ts (130 lines)
- **New**: core/anatomy/respiratory/store.ts (480 lines)
- **New**: core/anatomy/respiratory/index.ts
- **Modified**: prd.json - 4 stories marked passes: true

### Learnings for future iterations
- **Comprehensive sample data**: Include detailed examples for major structures (heart chambers, skull bones) as templates
- **5-level content pattern**: level1 (simple analogies), level2 (basic terminology), level3 (full medical), level4 (mechanisms), level5 (clinical)
- **Type unions for categories**: Use literal type unions for constrained categories (BoneType, VesselType)
- **Cross-references**: Link related structures (bones to joints, muscles to bones, vessels to organs)
- **Clinical correlations**: Include pathologies, relevant labs, and imaging at each level

---

## 2026-01-20 - US-046 through US-049

### What was implemented
Continued building comprehensive anatomical system modules following the established pattern:

**US-046: Digestive System Module**
- Created core/anatomy/digestive/ with types.ts, store.ts, index.ts
- Complete GI tract: oral cavity, pharynx, esophagus, stomach
- Small intestine segments (duodenum, jejunum, ileum) with detailed absorption info
- Large intestine segments (cecum through anal canal) with clinical correlations
- Accessory organs (liver, gallbladder, pancreas, salivary glands)
- Digestive enzymes with sources, substrates, products, optimal pH
- Nutrient absorption sites with transporters and mechanisms
- 5-level educational content for each structure
- API functions: getDigestiveStructure, getAccessoryOrgan, getEnzymesBySource, getAbsorptionSitesByLocation

**US-047: Nervous System Module**
- Created core/anatomy/nervous/ with types.ts, store.ts, index.ts
- Brain structures by lobe (frontal, temporal, parietal, occipital)
- Limbic system (hippocampus, amygdala)
- Diencephalon (thalamus, hypothalamus)
- Brainstem (midbrain, pons, medulla)
- Cerebellum with functional divisions
- All 12 cranial nerves with nuclei, foramina, functions
- Major peripheral nerves (median, ulnar, sciatic)
- Spinal cord with ascending/descending tracts
- Autonomic ganglia
- Spinal reflexes and dermatome map
- Neurotransmitters (ACh, dopamine, NE, serotonin, GABA, glutamate)
- 5-level educational content
- API functions: getBrainStructure, getCranialNerve, getPeripheralNerve, searchNervousStructures

**US-048: Endocrine System Module**
- Created core/anatomy/endocrine/ with types.ts, store.ts, index.ts
- Major endocrine glands (pituitary, thyroid, parathyroid, adrenal, pancreatic islets, gonads)
- Key hormones (insulin, cortisol, thyroid hormones, PTH, GH, aldosterone, ADH)
- Hormone regulation with stimulators and inhibitors
- Endocrine axes (HPA, HPT, HPG) with feedback loops
- Comprehensive pathologies (Cushing, Addison, Graves, Hashimoto, diabetes)
- 5-level educational content
- API functions: getEndocrineGland, getHormone, getEndocrineAxis, searchEndocrine

**US-049: Urinary System Module**
- Created core/anatomy/urinary/ with types.ts, store.ts, index.ts
- Gross anatomy (kidney, ureter, bladder, urethra)
- Nephron segments (glomerulus, PCT, loop of Henle, DCT, collecting duct)
- Detailed transporters with locations and mechanisms
- Renal factors (renin, EPO, calcitriol, prostaglandins)
- GFR concepts with calculations and determinants
- Countercurrent mechanism and concentration gradient
- 5-level educational content
- API functions: getUrinaryStructure, getNephronSegment, searchUrinary

### Files changed
- **New**: core/anatomy/digestive/types.ts (~130 lines)
- **New**: core/anatomy/digestive/store.ts (~1400 lines)
- **New**: core/anatomy/digestive/index.ts
- **New**: core/anatomy/nervous/types.ts (~200 lines)
- **New**: core/anatomy/nervous/store.ts (~1500 lines)
- **New**: core/anatomy/nervous/index.ts
- **New**: core/anatomy/endocrine/types.ts (~130 lines)
- **New**: core/anatomy/endocrine/store.ts (~1000 lines)
- **New**: core/anatomy/endocrine/index.ts
- **New**: core/anatomy/urinary/types.ts (~120 lines)
- **New**: core/anatomy/urinary/store.ts (~700 lines)
- **New**: core/anatomy/urinary/index.ts
- **Modified**: prd.json - 4 stories marked passes: true

### Learnings for future iterations
- **Physiological detail at level 5**: Include molecular mechanisms, ion channels, receptor types, signaling pathways
- **Clinical testing section**: Add examination techniques and diagnostic tests (reflexes, nerve conduction)
- **Transporter-drug connections**: Link tubular transporters to drug targets (SGLT2i, loop diuretics, thiazides)
- **Axis integration**: Show how endocrine axes connect multiple organs and feedback loops
- **Pathology patterns**: Distinguish hyper/hypo conditions with characteristic lab findings

---

## 2026-01-20 - US-050, US-051
- Implemented reproductive system module (US-050)
  - Male structures: testis, epididymis, vas deferens, prostate, seminal vesicle, penis
  - Female structures: ovary, fallopian tube, uterus, vagina
  - Gametogenesis stages (spermatogenesis, oogenesis) with hormonal regulation
  - Menstrual cycle phases with hormone correlations
  - Pregnancy milestones from fertilization to term
- Implemented lymphatic/immune system module (US-051)
  - Primary lymphoid organs: bone marrow, thymus
  - Secondary lymphoid organs: spleen, lymph nodes, tonsils
  - Immune cells: T cells (helper, cytotoxic), B cells, macrophages, neutrophils, NK cells, dendritic cells
  - Immunoglobulin classes (IgG, IgA, IgM, IgE, IgD)
  - Key cytokines (IL-1, IL-2, IL-6, TNF-α, IFN-γ)
  - Innate and adaptive immune response phases
- Files changed:
  - core/anatomy/reproductive/types.ts (new)
  - core/anatomy/reproductive/store.ts (new)
  - core/anatomy/reproductive/index.ts (new)
  - core/anatomy/lymphatic/types.ts (new)
  - core/anatomy/lymphatic/store.ts (new)
  - core/anatomy/lymphatic/index.ts (new)
  - prd.json (updated passes: true)
- **Learnings for future iterations:**
  - Immune system data has complex relationships between cells, cytokines, and responses
  - Surface markers (CD antigens) are essential for immune cell identification
  - Consider linking immune cells to their precursors in bone marrow
---

## 2026-01-20 - US-052
- Implemented integumentary system module
  - Skin layers: epidermis, dermis, hypodermis with detailed composition and functions
  - Epidermis sublayers: stratum corneum, lucidum, granulosum, spinosum, basale
  - Dermis structures: papillary and reticular dermis, vascular plexus
  - Hair follicle with growth cycle (anagen, catagen, telogen)
  - Sweat glands: eccrine (thermoregulation) and apocrine (scent/pheromones)
  - Sebaceous glands with holocrine secretion
  - Complete nail anatomy with all components
  - Wound healing phases: hemostasis, inflammation, proliferation, remodeling
  - Skin lesion morphology types (macule, papule, plaque, vesicle, etc.)
  - Skin receptors (Meissner, Merkel, Pacinian, Ruffini, free endings)
  - 5-level educational explanations
- Files changed:
  - core/anatomy/integumentary/types.ts (new)
  - core/anatomy/integumentary/store.ts (new)
  - core/anatomy/integumentary/index.ts (new)
  - prd.json (updated passes: true)
- **Learnings for future iterations:**
  - Skin receptors tie into both somatosensory and proprioception systems
  - Wound healing phases are a great teaching model for inflammation/repair
  - Consider linking skin lesion types to specific pathologies for clinical correlation
---

## 2026-01-20 - US-053
- Implemented system interconnection visualizations (physiological pathways)
  - RAAS: Complete renin-angiotensin-aldosterone cascade (6 steps)
  - HPT Axis: Hypothalamic-pituitary-thyroid with T4/T3 conversion
  - HPA Axis: Stress response pathway with cortisol
  - Enterohepatic Circulation: Bile acid recycling loop
  - Glucose-Insulin Pathway: Beta cell sensing to GLUT4 translocation
  - Each pathway includes feedback loops, cross-system connections
  - Detailed pathophysiology/disruptions with relevant labs
  - 5-level educational explanations
- Files changed:
  - core/physiology/pathways/types.ts (new)
  - core/physiology/pathways/store.ts (new)
  - core/physiology/pathways/index.ts (new)
  - prd.json (updated passes: true)
- **Learnings for future iterations:**
  - Pathways naturally connect to lab-organ mapping (US-054)
  - Cross-system connections are valuable for teaching systemic effects
  - Disruption data should link to relevant pathology modules
---

## 2026-01-20 - US-054
- Implemented lab-to-organ mapping database
  - CBC: WBC, Hemoglobin, Platelets, MCV
  - CMP: Glucose, Creatinine, BUN, Sodium, Potassium
  - LFTs: ALT, AST, ALP, Bilirubin
  - Lipid panel: Total Cholesterol, LDL
  - Thyroid: TSH, Free T4
  - Cardiac markers: Troponin, BNP
  - Coagulation: PT, PTT
  - LOINC codes for standardization
  - Reference ranges with sex/age variations
  - Clinical interpretations for abnormal values
  - 5-level educational explanations
  - Lab panels: CBC, CMP, LFT, Lipid, Thyroid, Coagulation
  - Organ-to-lab mappings for bidirectional queries
- Files changed:
  - core/labs/types.ts (new)
  - core/labs/store.ts (new)
  - core/labs/index.ts (new)
  - prd.json (updated passes: true)
- **Learnings for future iterations:**
  - LOINC codes provide standard terminology for interoperability
  - Lab interpretations naturally link to pathways and pathophysiology
  - Bidirectional queries (lab→organ, organ→labs) essential for clinical correlation
---

## 2026-01-20 - US-055
- Implemented biomarker pathway visualization module
  - Heme synthesis and bilirubin metabolism (12 enzyme steps)
    - Covers porphyrias, hemolysis, Gilbert syndrome pathophysiology
    - Phototherapy and phenobarbital treatment mechanisms
  - Urea cycle (5 enzyme steps)
    - OTC deficiency and hyperammonemia
    - Sodium benzoate/phenylbutyrate treatment mechanisms
  - Cholesterol synthesis pathway (9 major steps)
    - HMG-CoA reductase as statin target
    - PCSK9 inhibitor mechanism explained
  - Coagulation cascade (6 major steps)
    - Warfarin, heparin, DOAC drug targets
    - Factor deficiencies and DIC pathophysiology
  - Each pathway includes enzyme steps, abnormal states, treatment targets
  - 3D model highlight instructions for anatomical visualization
  - Lab-to-pathway links for bidirectional queries
  - 5-level educational explanations
- Files changed:
  - core/visualization/biomarker-pathways/types.ts (new)
  - core/visualization/biomarker-pathways/store.ts (new)
  - core/visualization/biomarker-pathways/index.ts (new)
  - prd.json (updated passes: true)
- **Learnings for future iterations:**
  - Enzyme steps should include EC numbers and gene names for precision
  - Treatment targets naturally link pharmacology to biochemistry
  - Model highlights enable 3D visualization coordination
---

## 2026-01-20 - US-056
- Implemented lipid metabolism deep dive module
  - Lipid absorption (7 steps): emulsification to lymphatic secretion
  - Lipoprotein particles: chylomicron, VLDL, LDL, HDL, Lp(a)
  - VLDL→LDL lifecycle (6 stages)
  - HDL reverse cholesterol transport (7 steps)
  - Atherosclerosis progression (7 stages from dysfunction to rupture)
  - Lipid-lowering drug mechanisms (statins, ezetimibe, PCSK9i, etc.)
  - Lab-lipid correlations
  - 5-level educational explanations
- Files changed:
  - core/physiology/metabolism/lipid/types.ts (new)
  - core/physiology/metabolism/lipid/store.ts (new)
  - core/physiology/metabolism/lipid/index.ts (new)
  - prd.json (updated passes: true)
- **Learnings for future iterations:**
  - Atherosclerosis stages map well to clinical presentations
  - Drug mechanisms should link to specific pathway targets
  - Lipoprotein lifecycle animations would benefit from this data structure
---

## 2026-01-21 - US-057
- Implemented glucose metabolism deep dive module
  - Glucose absorption (6 steps): digestion to systemic distribution
  - GLUT transporters: GLUT1-5, SGLT1/2 with tissue locations and kinetics
  - Insulin secretion (8 steps): glucose sensing to exocytosis
  - Insulin signaling cascade (8 steps): IR to GLUT4 translocation
  - Metabolic pathways: glycolysis, gluconeogenesis, glycogenesis, glycogenolysis
  - Type 1 and Type 2 diabetes pathophysiology
  - Diabetic complications: retinopathy, nephropathy, neuropathy, DKA
  - Anti-diabetic drugs: metformin, GLP-1 RA, SGLT2i, DPP-4i, etc.
  - Lab-glucose correlations: fasting glucose, HbA1c, OGTT, C-peptide
  - 5-level educational explanations
- Files changed:
  - core/physiology/metabolism/glucose/types.ts (new)
  - core/physiology/metabolism/glucose/store.ts (new)
  - core/physiology/metabolism/glucose/index.ts (new)
  - prd.json (updated passes: true)
- **Learnings for future iterations:**
  - Diabetes module naturally links to multiple organ complications
  - Drug mechanisms should highlight CV/renal benefits for modern diabetes care
  - GLUT transporter locations critical for understanding tissue-specific glucose handling
---

## 2026-01-21 - US-058
- Implemented electrolyte and fluid balance module
  - Nephron segment-by-segment electrolyte handling:
    - Glomerulus: ultrafiltration, GFR concepts
    - Proximal tubule: 65% Na+ reabsorption, NHE3, SGLT2
    - Thick ascending limb: NKCC2 (loop diuretic target), dilution
    - Distal tubule: NCC (thiazide target), TRPV5 Ca2+ handling
    - Collecting duct: ENaC, ROMK, AQP2 (aldosterone/ADH targets)
  - Aldosterone mechanism (8 steps): RAAS to Na+/K+ effects
  - ADH mechanism (9 steps): osmoreceptors to AQP2 insertion
  - PTH/Vitamin D/Calcitonin calcium axis (8 coordinated steps)
  - Fluid hormones: aldosterone, ADH, PTH, calcitonin, vitamin D, ANP
  - Acid-base physiology:
    - Buffer systems: bicarbonate, phosphate, protein, bone
    - Henderson-Hasselbalch concepts
  - Acid-base disorders with compensation formulas:
    - Metabolic acidosis (anion gap vs NAGMA)
    - Metabolic alkalosis (Cl-responsive vs resistant)
    - Respiratory acidosis (acute vs chronic)
    - Respiratory alkalosis
  - Clinical electrolyte disorders:
    - Hypo/hypernatremia with SIADH, DI pathophysiology
    - Hypo/hyperkalemia with ECG changes
    - Hypo/hypercalcemia with PTH algorithm
  - Fluid compartments: ICF, ECF, plasma, interstitial with Starling forces
  - Lab correlations with critical values
  - 5-level educational explanations for all content
- Files changed:
  - core/physiology/electrolytes/types.ts (new)
  - core/physiology/electrolytes/store.ts (new)
  - core/physiology/electrolytes/index.ts (new)
  - prd.json (updated passes: true)
- **Learnings for future iterations:**
  - Nephron segments should include drug targets for clinical relevance
  - Acid-base compensation formulas essential for clinical interpretation
  - ClinicalFeature severity type should include 'varies' for complex presentations
  - Electrolyte disorders naturally link to ECG findings and renal physiology
---

## 2026-01-21 - US-059
- Implemented one-click lab-to-anatomy exploration module
  - 12 comprehensive lab exploration contexts:
    - Hematology: Hemoglobin, WBC
    - Liver: ALT, Bilirubin
    - Kidney: Creatinine
    - Lipid: LDL Cholesterol
    - Thyroid: TSH
    - Cardiac: Troponin
    - Electrolyte: Sodium
    - Glucose: Glucose, HbA1c
    - Coagulation: PT/INR
  - Each context includes:
    - Primary organs with 3D highlight colors and roles
    - Related pathways with step highlights
    - 5-level physiology explanations
    - Related structures with explore prompts
    - Related labs with clinical reasoning
    - Clinical context (ranges, critical values, causes)
    - 3D view settings (camera, layers, opacity, focus)
  - API functions for UI integration
  - Lab result interpretation (low/normal/high/critical)
  - Exploration session management
- Files changed:
  - core/exploration/lab-exploration/types.ts (new)
  - core/exploration/lab-exploration/store.ts (new)
  - core/exploration/lab-exploration/index.ts (new)
  - prd.json (updated passes: true)
- **Learnings for future iterations:**
  - Lab exploration contexts bridge user data to educational content
  - 3D view settings should specify layer opacity for focused visualization
  - Clinical context with critical values enables urgent result flagging
  - Related labs list should include clinical reasoning for educational value
---

## 2026-01-21 - US-060
- Implemented symptom-to-anatomy mapping module
  - 6 major symptom mappings with comprehensive data:
    - Chest pain: cardiac, esophageal, musculoskeletal, pulmonary, aortic sources
    - Abdominal pain: stomach, gallbladder, appendix, pancreas, colon, wall
    - Headache: meninges, vessels, muscles, trigeminal, sinuses, cervical
    - Low back pain: muscles, disc, facets, stenosis, SI joint, kidney, aorta
    - Dyspnea: lungs, heart, PE, diaphragm, upper airway
    - Joint pain: synovium, cartilage, crystals, periarticular
  - Anatomical sources with likelihood weighting (common, less-common, rare, do-not-miss)
  - Referred pain patterns with dermatomal levels and mechanisms
  - Mechanism of symptom generation (pathway type, afferent, central processing)
  - Red flags with urgency levels (immediate, urgent, soon)
  - Symptom quality mappings for clinical correlation
  - 5-level explanations
  - API functions for search, highlights, exploration context
- Files changed:
  - core/exploration/symptom-anatomy/types.ts (new)
  - core/exploration/symptom-anatomy/store.ts (new)
  - core/exploration/symptom-anatomy/index.ts (new)
  - prd.json (updated passes: true)
- **Learnings for future iterations:**
  - "Do not miss" diagnoses should be highlighted prominently in UI
  - Referred pain patterns require dermatomal overlay visualization
  - Red flag urgency levels should drive UI warnings
  - Symptom quality (sharp vs dull) provides diagnostic clues
---

## 2026-01-21 - US-061
- Implemented differential diagnosis explorer module
  - Comprehensive type system for differential diagnoses:
    - 12 diagnosis categories (cardiovascular, respiratory, GI, neuro, etc.)
    - 5 care urgency levels (emergency to self-care)
    - 4 likelihood ranks (most-likely to rare-but-serious)
    - Pathophysiology with mechanism, progression, risk/protective factors
    - Clinical features (symptoms, signs, lab findings, imaging)
    - Red flags/alarm symptoms with action timeframes
    - Diagnostic workup (first-line, second-line, gold standard)
    - Differentiating tests to distinguish between diagnoses
    - Care guidance with urgency, setting, reasoning
  - 6 detailed differential diagnoses:
    - Acute coronary syndrome (ACS)
    - GERD
    - Tension headache
    - Migraine
    - Appendicitis
    - Pulmonary embolism (PE)
  - 4 symptom differential lists:
    - Chest pain (8 differentials, must-not-miss flagging)
    - Headache (6 differentials)
    - Abdominal pain (7 differentials)
    - Dyspnea (6 differentials)
  - Educational disclaimer emphasizing this is not medical advice
  - API functions for querying diagnoses, must-not-miss conditions
  - createDifferentialExplorerResult for building UI state
- Files changed:
  - core/exploration/differential-diagnosis/types.ts (new)
  - core/exploration/differential-diagnosis/store.ts (new)
  - core/exploration/differential-diagnosis/index.ts (new)
  - prd.json (updated passes: true)
- **Learnings for future iterations:**
  - Must-not-miss diagnoses require prominent visual treatment
  - ICD codes included for future integration with clinical systems
  - Red flags should specify both concern AND action timeframe
  - Likelihood rankings help structure differential presentation
  - 5-level explanations should cover same content at different depths
---
